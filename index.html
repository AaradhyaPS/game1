<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Endless Level Devil — Upgraded</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f14;font-family:Inter,Arial,Helvetica,sans-serif}
  #uiTop{position:fixed;left:10px;top:10px;z-index:30;color:#fff}
  #uiTop .box{background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:8px;margin-bottom:8px}
  #uiRight{position:fixed;right:10px;top:10px;z-index:30;color:#fff}
  #canvasWrap{display:flex;align-items:center;justify-content:center;height:100vh}
  canvas{border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);background:#87CEEB;max-width:100%;height:auto}
  #controls{position:fixed;right:14px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:30}
  .btn{background:#ff7f50;border:0;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;box-shadow:0 4px 8px rgba(0,0,0,.25);touch-action:none}
  .small{font-size:12px;padding:6px 8px;background:rgba(255,255,255,0.95);color:#000;border-radius:6px}
  #menu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:50;color:#fff;display:flex;flex-direction:column;align-items:center;gap:12px}
  #menu .panel{background:linear-gradient(180deg,rgba(0,0,0,0.75),rgba(0,0,0,0.5));padding:18px;border-radius:14px;text-align:center;width:320px}
  #menu button{width:100%;margin-top:6px}
  .mutebtn{background:#444;border-radius:8px;padding:6px 8px;color:#fff}
  #footerNote{position:fixed;left:10px;bottom:10px;color:#fff;opacity:0.6;font-size:12px}
  @media (max-width:600px){ #menu .panel{width:90vw} canvas{width:95vw;height:auto} }
</style>
</head>
<body>
<div id="canvasWrap">
  <canvas id="game" width="1000" height="560"></canvas>
</div>

<div id="uiTop">
  <div class="box">Level: <span id="level">1</span> &nbsp; Score: <span id="score">0</span></div>
  <div class="box"><span id="high">Best: 0</span></div>
</div>

<div id="uiRight">
  <div class="small" id="themeLabel">Theme: Forest</div>
  <div style="height:8px"></div>
  <button id="mute" class="mutebtn">Mute</button>
</div>

<div id="controls">
  <button id="acc" class="btn">▶</button>
  <button id="jump" class="btn">▲</button>
  <button id="pause" class="btn">Pause</button>
</div>

<div id="menu">
  <div class="panel" id="startPanel">
    <h2 style="margin:6px 0 0 0">Endless Level Devil</h2>
    <p style="opacity:0.9">Progressive endless levels — dodge traps, survive, get a high score.</p>
    <button id="startBtn" class="btn">Start Game</button>
    <button id="how" class="btn" style="background:#6b8cff">How to Play</button>
    <div style="height:8px"></div>
    <div style="font-size:12px;opacity:0.8">Controls: A/D or ←/→, W / Space to jump. Mobile: use buttons.</div>
  </div>

  <div class="panel" id="pausePanel" style="display:none">
    <h3>Paused</h3>
    <button id="resume" class="btn">Resume</button>
    <button id="restart" class="btn" style="background:#e74c3c">Restart</button>
  </div>

  <div class="panel" id="howPanel" style="display:none">
    <h3>How to Play</h3>
    <p>Reach the end of each generated segment to advance to the next. Difficulty increases as you progress. Avoid spikes, fake floors, pop-up traps and moving hazards.</p>
    <button id="backToMenu" class="btn">Back</button>
  </div>
</div>

<div id="footerNote">Made by Aaradhya • Save to GitHub Pages to host</div>

<script>
/* ----------------- CONFIG ----------------- */
/* Tweak constants here */
const BASE_CANVAS_W = 1000, BASE_CANVAS_H = 560;
const CAMERA_LEFT_PADDING = 260;
const SEGMENT_W = 700;           // width of generated segments
const START_SEGMENTS = 5;        // how many segments per first level
const BASE_DIFFICULTY = 0.12;    // base difficulty ramp
const MAX_SPAWN_TRAPS = 200;

/* Audio toggles */
let SOUND_ON = true;

/* ----------------- Canvas & Scaling ----------------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = BASE_CANVAS_W; canvas.height = BASE_CANVAS_H;

/* UI elements */
const levelEl = document.getElementById('level');
const scoreEl = document.getElementById('score');
const highEl = document.getElementById('high');
const themeLabel = document.getElementById('themeLabel');
const muteBtn = document.getElementById('mute');
const startPanel = document.getElementById('startPanel');
const pausePanel = document.getElementById('pausePanel');
const howPanel = document.getElementById('howPanel');

/* touch controls */
const btnAcc = document.getElementById('acc');
const btnJump = document.getElementById('jump');
const pauseBtn = document.getElementById('pause');

/* Menu buttons */
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('how').addEventListener('click', ()=>{ startPanel.style.display='none'; howPanel.style.display='block'; });
document.getElementById('backToMenu').addEventListener('click', ()=>{ howPanel.style.display='none'; startPanel.style.display='block'; });
document.getElementById('resume').addEventListener('click', resumeGame);
document.getElementById('restart').addEventListener('click', ()=>{ resetAll(true); });

/* mute */
muteBtn.addEventListener('click', ()=>{ SOUND_ON = !SOUND_ON; muteBtn.innerText = SOUND_ON ? 'Mute' : 'Unmute'; });

/* High score in localStorage */
let HIGH_SCORE = parseInt(localStorage.getItem('lvl_high')||'0');
highEl.innerText = 'Best: ' + HIGH_SCORE;

/* ----------------- Input ----------------- */
let keys = {};
window.addEventListener('keydown', e => { keys[e.key] = true; if(e.key==='p') togglePause(); if(e.key==='m'){ SOUND_ON = !SOUND_ON; muteBtn.innerText = SOUND_ON ? 'Mute' : 'Unmute'; }});
window.addEventListener('keyup', e => { keys[e.key] = false; });

btnAcc.addEventListener('pointerdown', ()=> keys['ArrowRight'] = true);
btnAcc.addEventListener('pointerup', ()=> keys['ArrowRight'] = false);
btnAcc.addEventListener('pointercancel', ()=> keys['ArrowRight'] = false);
btnJump.addEventListener('pointerdown', ()=>{ keys[' '] = true; setTimeout(()=> keys[' '] = false, 120); });

pauseBtn.addEventListener('click', togglePause);

/* ----------------- Audio - simple WebAudio SFX generator ----------------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new AudioCtx();
}
function playTone(freq=440, type='sine', dur=0.08, vol=0.12){
  if(!SOUND_ON) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
  setTimeout(()=> o.stop(), dur*1000+20);
}
function playClick(){ playTone(880,'sawtooth',0.06,0.08) }
function playJump(){ playTone(520,'triangle',0.12,0.12) }
function playDie(){ playTone(140,'sine',0.26,0.18); playTone(120,'sine',0.28,0.06) }
function playLand(){ playTone(240,'square',0.06,0.08) }

/* ----------------- Game Entities ----------------- */
class Player {
  constructor(){ this.reset(); }
  reset(){
    this.x = 120; this.y = 360; this.w = 36; this.h = 52;
    this.vx = 0; this.vy = 0; this.onGround = false; this.anim = 0; this.facing=1;
  }
  update(dt){
    // controls
    const accel = 0.25 * (dt/16);
    if(keys['a'] || keys['ArrowLeft']) this.vx -= accel, this.facing=-1;
    if(keys['d'] || keys['ArrowRight']) this.vx += accel, this.facing=1;
    // limit
    this.vx = Math.max(-4.2, Math.min(this.vx, 6.2));
    this.vx *= 0.993;
    // gravity
    this.vy += 0.9 * (dt/16);
    // jump
    if((keys['w'] || keys[' '] || keys['ArrowUp']) && this.onGround){
      this.vy = -15.6; this.onGround=false; if(SOUND_ON) playJump();
    }
    // apply
    this.x += this.vx * (dt/16);
    this.y += this.vy * (dt/16);

    // collisions with platforms
    this.onGround = false;
    for(let p of level.platforms){
      if(this.x + this.w > p.x && this.x < p.x + p.w){
        // vertical collision only if falling
        if(this.y + this.h > p.y && this.y + this.h < p.y + 22 && this.vy >= 0){
          this.y = p.y - this.h;
          this.vy = 0;
          this.onGround = true;
          // carry with moving platform
          if(p.type === 'moving' && p.vx) this.x += p.vx * (dt/16);
        }
      }
    }
    // spikes
    for(let s of level.spikes){
      if(this.x + this.w > s.x && this.x < s.x + s.w &&
         this.y + this.h > s.y && this.y < s.y + s.h){
           this.die();
      }
    }
    // popSpikes
    for(let ps of level.popSpikes){
      if(ps.active && this.x + this.w > ps.x && this.x < ps.x + ps.w &&
         this.y + this.h > ps.y && this.y < ps.y + ps.h){
           this.die();
      }
    }
    // falling kill
    if(this.y > canvas.height + 200) this.die();

    // animation step
    this.anim += Math.abs(this.vx) * 0.05;
  }
  die(){
    if(SOUND_ON) playDie();
    // decrement score small
    score = Math.max(0, score - 80);
    // reset to level start
    player.reset();
    camX = Math.max(0, player.x - CAMERA_LEFT_PADDING);
  }
  draw(){
    // body with simple running animation
    const px = this.x - camX, py = this.y;
    ctx.save();
    ctx.translate(px + this.w/2, py + this.h/2);
    if(this.facing<0) ctx.scale(-1,1);
    // shadow
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.beginPath(); ctx.ellipse(-8, this.h/2 + 6, 20, 8, 0,0,Math.PI*2); ctx.fill();
    // body
    ctx.fillStyle = '#0b3d91';
    const bob = Math.sin(this.anim) * 2;
    ctx.fillRect(-this.w/2, -this.h/2 + bob, this.w, this.h);
    // head
    ctx.fillStyle = '#ffd9b6';
    ctx.fillRect(-this.w/2 + 6, -this.h/2 - 12 + bob, 18, 20);
    // eye
    ctx.fillStyle = '#000'; ctx.fillRect(6, -this.h/2 - 6 + bob, 6, 6);
    ctx.restore();
  }
}

class Platform {
  constructor(x,y,w,type='static',vx=0,range=0){
    this.x=x; this.y=y; this.w=w; this.h=20; this.type=type; this.vx=vx; this.range=range; this.origX=x;
  }
  update(dt){
    if(this.type==='moving'){
      this.x += this.vx * (dt/16);
      if(this.x < this.origX - this.range || this.x > this.origX + this.range) this.vx *= -1;
    }
  }
  draw(){
    ctx.fillStyle = (this.type==='moving')? '#4b8aff' : '#5e4f3b';
    ctx.fillRect(this.x - camX, this.y, this.w, this.h);
    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
    ctx.strokeRect(this.x - camX, this.y, this.w, this.h);
  }
}

class Spike {
  constructor(x,y,w=28){ this.x=x; this.y=y; this.w=w; this.h=w; }
  draw(){
    ctx.fillStyle = '#c62828';
    ctx.beginPath();
    ctx.moveTo(this.x - camX, this.y + this.h);
    ctx.lineTo(this.x - camX + this.w/2, this.y);
    ctx.lineTo(this.x - camX + this.w, this.y + this.h);
    ctx.fill();
    ctx.strokeStyle = '#7b0000'; ctx.stroke();
  }
}

class PopSpike {
  constructor(x,y){ this.x=x; this.baseY=y + 42; this.y=this.baseY; this.w=28; this.h=28; this.triggerAt = x-140; this.active=false; this.timer=0; }
  activate(){ this.active=true; this.timer=18; }
  update(dt){
    if(this.active
